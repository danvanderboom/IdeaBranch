<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:IdeaBranch.App.ViewModels"
             xmlns:search="clr-namespace:IdeaBranch.App.Services.Search"
             xmlns:domain="clr-namespace:IdeaBranch.Domain;assembly=IdeaBranch.Domain"
             x:Class="IdeaBranch.App.Views.AdvancedSearchPage"
             x:DataType="vm:AdvancedSearchViewModel"
             Title="Advanced Search">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Search Filters Section -->
        <ScrollView Grid.Row="0" Padding="12" AutomationId="AdvancedSearchPage_Filters">
            <VerticalStackLayout Spacing="12">
                <!-- Text Search -->
                <VerticalStackLayout Spacing="4">
                    <Label Text="Search Text" FontAttributes="Bold" FontSize="14" />
                    <Entry Text="{Binding SearchText}" 
                           Placeholder="Enter search text..."
                           AutomationId="AdvancedSearchPage_SearchText" />
                </VerticalStackLayout>

                <!-- Content Types -->
                <VerticalStackLayout Spacing="4">
                    <Label Text="Content Types" FontAttributes="Bold" FontSize="14" />
                    <HorizontalStackLayout Spacing="8">
                        <CheckBox x:Name="CheckTopicNodes" IsChecked="False" CheckedChanged="OnContentTypeCheckedChanged" AutomationId="AdvancedSearchPage_CheckTopicNodes" />
                        <Label Text="Topic Nodes" VerticalOptions="Center" />
                        <CheckBox x:Name="CheckAnnotations" IsChecked="False" CheckedChanged="OnContentTypeCheckedChanged" AutomationId="AdvancedSearchPage_CheckAnnotations" />
                        <Label Text="Annotations" VerticalOptions="Center" />
                        <CheckBox x:Name="CheckTags" IsChecked="False" CheckedChanged="OnContentTypeCheckedChanged" AutomationId="AdvancedSearchPage_CheckTags" />
                        <Label Text="Tags" VerticalOptions="Center" />
                        <CheckBox x:Name="CheckTemplates" IsChecked="False" CheckedChanged="OnContentTypeCheckedChanged" AutomationId="AdvancedSearchPage_CheckTemplates" />
                        <Label Text="Templates" VerticalOptions="Center" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>

                <!-- Include Tags -->
                <VerticalStackLayout Spacing="4">
                    <Label Text="Include Tags (AND)" FontAttributes="Bold" FontSize="14" />
                    <Button Text="{Binding IncludeTagsDisplayText, TargetNullValue='Select Tags...'}" 
                            Clicked="OnIncludeTagsClicked"
                            AutomationId="AdvancedSearchPage_IncludeTags" />
                </VerticalStackLayout>

                <!-- Exclude Tags -->
                <VerticalStackLayout Spacing="4">
                    <Label Text="Exclude Tags" FontAttributes="Bold" FontSize="14" />
                    <Button Text="{Binding ExcludeTagsDisplayText, TargetNullValue='Select Tags...'}" 
                            Clicked="OnExcludeTagsClicked"
                            AutomationId="AdvancedSearchPage_ExcludeTags" />
                </VerticalStackLayout>

                <!-- UpdatedAt Range -->
                <VerticalStackLayout Spacing="4">
                    <Label Text="Updated At Range" FontAttributes="Bold" FontSize="14" />
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                        <VerticalStackLayout Grid.Column="0" Spacing="4">
                            <Label Text="From" FontSize="12" />
                            <DatePicker x:Name="UpdatedAtFromPicker" 
                                       DateSelected="OnUpdatedAtFromDateSelected"
                                       AutomationId="AdvancedSearchPage_UpdatedAtFrom" />
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="1" Spacing="4">
                            <Label Text="To" FontSize="12" />
                            <DatePicker x:Name="UpdatedAtToPicker" 
                                       DateSelected="OnUpdatedAtToDateSelected"
                                       AutomationId="AdvancedSearchPage_UpdatedAtTo" />
                        </VerticalStackLayout>
                    </Grid>
                </VerticalStackLayout>

                <!-- Temporal Range (for annotations) -->
                <VerticalStackLayout Spacing="4" IsVisible="{Binding ShowTemporalRange}">
                    <Label Text="Temporal/Historical Range" FontAttributes="Bold" FontSize="14" />
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                        <VerticalStackLayout Grid.Column="0" Spacing="4">
                            <Label Text="From" FontSize="12" />
                            <DatePicker x:Name="TemporalStartPicker" 
                                       DateSelected="OnTemporalStartDateSelected"
                                       AutomationId="AdvancedSearchPage_TemporalStart" />
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="1" Spacing="4">
                            <Label Text="To" FontSize="12" />
                            <DatePicker x:Name="TemporalEndPicker" 
                                       DateSelected="OnTemporalEndDateSelected"
                                       AutomationId="AdvancedSearchPage_TemporalEnd" />
                        </VerticalStackLayout>
                    </Grid>
                </VerticalStackLayout>

                <!-- Action Buttons -->
                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                    <Button Grid.Column="0" 
                            Text="Search" 
                            Command="{Binding ExecuteSearchCommand}"
                            IsEnabled="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
                            AutomationId="AdvancedSearchPage_SearchButton" />
                    <Button Grid.Column="1" 
                            Text="Clear" 
                            Clicked="OnClearClicked"
                            AutomationId="AdvancedSearchPage_ClearButton" />
                    <Button Grid.Column="2" 
                            Text="Save" 
                            Clicked="OnSaveClicked"
                            IsEnabled="False"
                            AutomationId="AdvancedSearchPage_SaveButton" />
                </Grid>

                <!-- Error Message -->
                <Label Text="{Binding ErrorMessage}" 
                       TextColor="Red" 
                       IsVisible="{Binding HasError}"
                       AutomationId="AdvancedSearchPage_ErrorMessage" />
            </VerticalStackLayout>
        </ScrollView>

        <!-- Results Section -->
        <Grid Grid.Row="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Results Header -->
            <Grid Grid.Row="0" Padding="12" BackgroundColor="#F5F5F5">
                <Label Text="{Binding TotalResultCount, StringFormat='{0} results'}" 
                       FontAttributes="Bold"
                       AutomationId="AdvancedSearchPage_ResultCount" />
                <ActivityIndicator Grid.Column="1" 
                                  IsRunning="{Binding IsLoading}"
                                  HorizontalOptions="End"
                                  AutomationId="AdvancedSearchPage_LoadingIndicator" />
            </Grid>

            <!-- Results Content -->
            <ScrollView Grid.Row="1" IsVisible="{Binding HasResults}">
                <VerticalStackLayout Spacing="12" Padding="12">
                    <!-- Topic Nodes Results -->
                    <VerticalStackLayout IsVisible="{Binding Results.Nodes.Count, Converter={StaticResource CountToBool}}">
                        <Label Text="Topic Nodes" FontAttributes="Bold" FontSize="16" />
                        <CollectionView ItemsSource="{Binding Results.Nodes}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="search:TopicNodeSearchResult">
                                    <Grid Padding="8" BackgroundColor="#F9F9F9" Margin="0,4">
                                        <VerticalStackLayout>
                                            <Label Text="{Binding Title, TargetNullValue='(No Title)'}" FontAttributes="Bold" />
                                            <Label Text="{Binding Prompt}" FontSize="12" TextColor="Gray" LineBreakMode="TailTruncation" />
                                            <Label Text="{Binding UpdatedAt, StringFormat='Updated: {0:g}'}" FontSize="10" TextColor="DarkGray" />
                                        </VerticalStackLayout>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>

                    <!-- Annotations Results -->
                    <VerticalStackLayout IsVisible="{Binding Results.Annotations.Count, Converter={StaticResource CountToBool}}">
                        <Label Text="Annotations" FontAttributes="Bold" FontSize="16" />
                        <CollectionView ItemsSource="{Binding Results.Annotations}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="domain:Annotation">
                                    <Grid Padding="8" BackgroundColor="#F9F9F9" Margin="0,4">
                                        <VerticalStackLayout>
                                            <Label Text="{Binding Comment, TargetNullValue='(No Comment)'}" FontAttributes="Bold" />
                                            <Label Text="{Binding UpdatedAt, StringFormat='Updated: {0:g}'}" FontSize="10" TextColor="DarkGray" />
                                        </VerticalStackLayout>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>

                    <!-- Tags Results -->
                    <VerticalStackLayout IsVisible="{Binding Results.Tags.Count, Converter={StaticResource CountToBool}}">
                        <Label Text="Tags" FontAttributes="Bold" FontSize="16" />
                        <CollectionView ItemsSource="{Binding Results.Tags}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="domain:TagTaxonomyNode">
                                    <Grid Padding="8" BackgroundColor="#F9F9F9" Margin="0,4">
                                        <Label Text="{Binding Name}" FontAttributes="Bold" />
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>

                    <!-- Templates Results -->
                    <VerticalStackLayout IsVisible="{Binding Results.Templates.Count, Converter={StaticResource CountToBool}}">
                        <Label Text="Prompt Templates" FontAttributes="Bold" FontSize="16" />
                        <CollectionView ItemsSource="{Binding Results.Templates}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="domain:PromptTemplate">
                                    <Grid Padding="8" BackgroundColor="#F9F9F9" Margin="0,4">
                                        <VerticalStackLayout>
                                            <Label Text="{Binding Name}" FontAttributes="Bold" />
                                            <Label Text="{Binding Body}" FontSize="12" TextColor="Gray" LineBreakMode="TailTruncation" />
                                        </VerticalStackLayout>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </ScrollView>

            <!-- Empty State -->
            <Label Grid.Row="1" 
                   Text="No results found. Adjust your search filters and try again." 
                   HorizontalOptions="Center" 
                   VerticalOptions="Center"
                   IsVisible="{Binding HasResults, Converter={StaticResource InvertedBoolConverter}}"
                   AutomationId="AdvancedSearchPage_EmptyState" />
        </Grid>
    </Grid>
</ContentPage>
