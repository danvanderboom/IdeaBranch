<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:IdeaBranch.App.ViewModels"
             xmlns:res="clr-namespace:IdeaBranch.App.Resources"
             x:Class="IdeaBranch.App.Views.AnnotationEditPage"
             x:DataType="vm:AnnotationEditViewModel"
             Title="{x:Static res:AppResources.AnnotationEditPage_Title}"
             AutomationId="AnnotationEditPage">
    <ScrollView>
        <Grid Padding="16" RowSpacing="16">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Selected Text -->
            <VerticalStackLayout Grid.Row="0" Spacing="4">
                <Label Text="{x:Static res:AppResources.AnnotationEditPage_SelectedTextLabel}" FontAttributes="Bold" />
                <Border BackgroundColor="#F5F5F5"
                        StrokeThickness="1"
                        Stroke="#E0E0E0"
                        Padding="12"
                        Margin="0,4,0,0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="4" />
                    </Border.StrokeShape>
                    <Label Text="{Binding SelectedText}"
                           FontSize="14"
                           TextColor="Gray"
                           AutomationId="AnnotationEditPage_SelectedText"
                           SemanticProperties.Description="The selected text span for this annotation" />
                </Border>
            </VerticalStackLayout>

            <!-- Comment -->
            <VerticalStackLayout Grid.Row="1" Spacing="4">
                <Label Text="{x:Static res:AppResources.AnnotationEditPage_CommentLabel}" FontAttributes="Bold" />
                <Editor Text="{Binding Comment}"
                        Placeholder="{x:Static res:AppResources.AnnotationEditPage_CommentPlaceholder}"
                        HeightRequest="100"
                        AutomationId="AnnotationEditPage_Comment"
                        SemanticProperties.Description="Enter an optional comment for this annotation" />
            </VerticalStackLayout>

            <!-- Tags -->
            <VerticalStackLayout Grid.Row="2" Spacing="4">
                <Label Text="{x:Static res:AppResources.AnnotationEditPage_TagsLabel}" FontAttributes="Bold" />
                <Border BackgroundColor="#F5F5F5"
                        StrokeThickness="1"
                        Stroke="#E0E0E0"
                        Padding="12"
                        Margin="0,4,0,0"
                        HeightRequest="150">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="4" />
                    </Border.StrokeShape>
                    <CollectionView ItemsSource="{Binding AvailableTags}"
                                    SelectionMode="None"
                                    AutomationId="AnnotationEditPage_TagsList">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="4">
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnTagTapped" CommandParameter="{Binding .}" />
                                    </Grid.GestureRecognizers>
                                    <CheckBox x:Name="TagCheckBox"
                                              IsChecked="{Binding IsSelected}"
                                              HorizontalOptions="Start"
                                              VerticalOptions="Center" />
                                    <Label Text="{Binding Name}"
                                           FontSize="14"
                                           Margin="32,0,0,0"
                                           VerticalOptions="Center"
                                           VerticalTextAlignment="Center" />
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                        <CollectionView.EmptyView>
                            <Label Text="{x:Static res:AppResources.AnnotationEditPage_NoTagsLabel}"
                                   FontSize="12"
                                   TextColor="Gray"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"
                                   Margin="0,20" />
                        </CollectionView.EmptyView>
                    </CollectionView>
                </Border>
            </VerticalStackLayout>

            <!-- Optional Values Section -->
            <VerticalStackLayout Grid.Row="3" Spacing="8" Margin="0,8,0,0">
                <Label Text="{x:Static res:AppResources.AnnotationEditPage_OptionalValuesLabel}" 
                       FontAttributes="Bold"
                       FontSize="16" />
            </VerticalStackLayout>

            <!-- Numeric Value -->
            <VerticalStackLayout Grid.Row="4" Spacing="4">
                <Label Text="{x:Static res:AppResources.AnnotationEditPage_NumericValueLabel}" FontAttributes="Bold" />
                <Entry Text="{Binding NumericValue, StringFormat='{0:F2}'}"
                       Placeholder="{x:Static res:AppResources.AnnotationEditPage_NumericValuePlaceholder}"
                       Keyboard="Numeric"
                       AutomationId="AnnotationEditPage_NumericValue"
                       SemanticProperties.Description="Enter an optional numeric value" />
            </VerticalStackLayout>

            <!-- Temporal Value -->
            <VerticalStackLayout Grid.Row="5" Spacing="4">
                <Label Text="{x:Static res:AppResources.AnnotationEditPage_TemporalValueLabel}" FontAttributes="Bold" />
                <DatePicker Date="{Binding TemporalValue, Mode=TwoWay}"
                           AutomationId="AnnotationEditPage_TemporalValue"
                           SemanticProperties.Description="Select an optional date for this annotation" />
            </VerticalStackLayout>

            <!-- Geospatial Value -->
            <VerticalStackLayout Grid.Row="6" Spacing="4">
                <Label Text="{x:Static res:AppResources.AnnotationEditPage_GeospatialValueLabel}" FontAttributes="Bold" />
                <Editor Text="{Binding GeospatialValue}"
                       Placeholder="{x:Static res:AppResources.AnnotationEditPage_GeospatialValuePlaceholder}"
                       HeightRequest="80"
                       AutomationId="AnnotationEditPage_GeospatialValue"
                       SemanticProperties.Description="Enter an optional geospatial value (GeoJSON format) for this annotation" />
            </VerticalStackLayout>

            <!-- Error banner -->
            <Border Grid.Row="7"
                    BackgroundColor="#FFEBEE"
                    StrokeThickness="1"
                    Stroke="#F44336"
                    Padding="12"
                    Margin="0,8,0,0"
                    IsVisible="{Binding HasError}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="4" />
                </Border.StrokeShape>
                <Label Text="{Binding ErrorMessage}"
                       TextColor="#C62828"
                       FontSize="14"
                       FontAttributes="Bold"
                       AutomationId="AnnotationEditPage_ErrorMessage" />
            </Border>

            <!-- Action buttons -->
            <Grid Grid.Row="8" ColumnSpacing="8" Margin="0,8,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                
                <Button Grid.Column="0"
                        Text="{x:Static res:AppResources.AnnotationEditPage_DeleteButton}"
                        Clicked="OnDeleteClicked"
                        IsVisible="{Binding IsEditing}"
                        BackgroundColor="#F44336"
                        TextColor="White"
                        IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                        AutomationId="AnnotationEditPage_Delete"
                        SemanticProperties.Hint="Deletes this annotation" />
                
                <Button Grid.Column="1"
                        Text="{x:Static res:AppResources.AnnotationEditPage_CancelButton}"
                        Clicked="OnCancelClicked"
                        IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                        AutomationId="AnnotationEditPage_Cancel"
                        SemanticProperties.Hint="Cancels editing and discards changes" />
                
                <Button Grid.Column="2"
                        Text="{x:Static res:AppResources.AnnotationEditPage_SaveButton}"
                        Clicked="OnSaveClicked"
                        IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                        AutomationId="AnnotationEditPage_Save"
                        SemanticProperties.Hint="Saves this annotation" />
            </Grid>
        </Grid>
    </ScrollView>
</ContentPage>

