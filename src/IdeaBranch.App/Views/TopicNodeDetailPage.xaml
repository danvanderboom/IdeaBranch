<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:IdeaBranch.App.ViewModels"
             xmlns:res="clr-namespace:IdeaBranch.App.Resources"
             x:Class="IdeaBranch.App.Views.TopicNodeDetailPage"
             x:DataType="vm:TopicNodeDetailViewModel"
             Title="{x:Static res:AppResources.TopicNodeDetailPage_Title}"
             AutomationId="TopicNodeDetailPage">
    <ScrollView>
        <Grid Padding="16" RowSpacing="16">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Parent path breadcrumb -->
            <Label Grid.Row="0"
                   Text="{Binding ParentPath}"
                   FontSize="12"
                   TextColor="Gray"
                   AutomationId="TopicNodeDetailPage_ParentPath" />

            <!-- Title -->
            <VerticalStackLayout Grid.Row="1" Spacing="4">
                <Label Text="{x:Static res:AppResources.TopicNodeDetailPage_TitleLabel}" FontAttributes="Bold" />
                <Entry Text="{Binding Title}"
                       Placeholder="{x:Static res:AppResources.TopicNodeDetailPage_TitlePlaceholder}"
                       AutomationId="TopicNodeDetailPage_Title"
                       SemanticProperties.Description="Enter or edit the title for this topic node" />
            </VerticalStackLayout>

            <!-- Prompt -->
            <VerticalStackLayout Grid.Row="2" Spacing="4">
                <Label Text="{x:Static res:AppResources.TopicNodeDetailPage_PromptLabel}" FontAttributes="Bold" />
                <Editor Text="{Binding Prompt}"
                        Placeholder="{x:Static res:AppResources.TopicNodeDetailPage_PromptPlaceholder}"
                        HeightRequest="100"
                        AutomationId="TopicNodeDetailPage_Prompt"
                        SemanticProperties.Description="Enter or edit the prompt text for this topic node" />
            </VerticalStackLayout>

            <!-- Response -->
            <VerticalStackLayout Grid.Row="3" Spacing="4">
                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                    <Label Grid.Column="0"
                           Text="{x:Static res:AppResources.TopicNodeDetailPage_ResponseLabel}" 
                           FontAttributes="Bold" />
                    <Button Grid.Column="1"
                            Text="{x:Static res:AppResources.TopicNodeDetailPage_AnnotateButton}"
                            Clicked="OnAnnotateSelectionClicked"
                            IsEnabled="{Binding HasTextSelection}"
                            Padding="8,4"
                            FontSize="12"
                            BackgroundColor="#E3F2FD"
                            TextColor="#1976D2"
                            AutomationId="TopicNodeDetailPage_AnnotateButton"
                            SemanticProperties.Hint="Create an annotation for the selected text"
                            IsVisible="{Binding HasTextSelection}" />
                </Grid>
                <Editor x:Name="ResponseEditor"
                        Text="{Binding Response}"
                        Placeholder="{x:Static res:AppResources.TopicNodeDetailPage_ResponsePlaceholder}"
                        HeightRequest="200"
                        AutomationId="TopicNodeDetailPage_Response"
                        SemanticProperties.Description="Enter or edit the response text for this topic node"
                        TextChanged="OnResponseTextChanged"
                        Focused="OnResponseFocused" />
            </VerticalStackLayout>

            <!-- Annotations Section -->
            <VerticalStackLayout Grid.Row="4" Spacing="4" Margin="0,8,0,0">
                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                    <Label Grid.Column="0"
                           Text="{x:Static res:AppResources.TopicNodeDetailPage_AnnotationsLabel}"
                           FontAttributes="Bold" />
                    <CheckBox Grid.Column="1"
                              IsChecked="{Binding ShowComments}"
                              VerticalOptions="Center"
                              AutomationId="TopicNodeDetailPage_ShowComments"
                              SemanticProperties.Description="Toggle visibility of annotation comments" />
                    <Label Grid.Column="1"
                           Text="{x:Static res:AppResources.TopicNodeDetailPage_ShowCommentsLabel}"
                           FontSize="12"
                           VerticalOptions="Center"
                           Margin="8,0,0,0" />
                </Grid>
                <CollectionView ItemsSource="{Binding FilteredAnnotations}"
                                SelectionMode="Single"
                                SelectedItem="{Binding SelectedAnnotation}"
                                SelectionChanged="OnAnnotationSelected"
                                AutomationId="TopicNodeDetailPage_AnnotationsList">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Grid Padding="8" BackgroundColor="#F5F5F5" Margin="0,4">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnAnnotationTapped" CommandParameter="{Binding .}" />
                                </Grid.GestureRecognizers>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>
                                <Label Grid.Row="0"
                                       Text="{Binding Comment}"
                                       FontSize="14"
                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type vm:TopicNodeDetailViewModel}}, Path=ShowComments}"
                                       AutomationId="{Binding Id, StringFormat='Annotation_{0}_Comment'}" />
                                <Label Grid.Row="1"
                                       FontSize="12"
                                       TextColor="Gray"
                                       Margin="0,4,0,0"
                                       AutomationId="{Binding Id, StringFormat='Annotation_{0}_Offset'}">
                                    <Label.Text>
                                        <MultiBinding StringFormat="Offset: {0}-{1}">
                                            <Binding Path="StartOffset" />
                                            <Binding Path="EndOffset" />
                                        </MultiBinding>
                                    </Label.Text>
                                </Label>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                    <CollectionView.EmptyView>
                        <Label Text="{x:Static res:AppResources.TopicNodeDetailPage_NoAnnotationsLabel}"
                               FontSize="14"
                               TextColor="Gray"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               Margin="0,20"
                               AutomationId="TopicNodeDetailPage_NoAnnotations" />
                    </CollectionView.EmptyView>
                </CollectionView>
            </VerticalStackLayout>

            <!-- Error banner with retry -->
            <Border Grid.Row="5"
                    BackgroundColor="#FFEBEE"
                    StrokeThickness="1"
                    Stroke="#F44336"
                    Padding="12"
                    Margin="0,8,0,0"
                    IsVisible="{Binding HasError}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="4" />
                </Border.StrokeShape>
                <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto" ColumnSpacing="8">
                    <Label Grid.Row="0"
                           Grid.Column="0"
                           Grid.ColumnSpan="2"
                           Text="{Binding ErrorMessage}"
                           TextColor="#C62828"
                           FontSize="14"
                           FontAttributes="Bold"
                           AutomationId="TopicNodeDetailPage_ErrorMessage" />
                    <Button Grid.Row="1"
                            Grid.Column="0"
                            Text="{x:Static res:AppResources.TopicNodeDetailPage_RetryButton}"
                            Clicked="OnRetryClicked"
                            IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                            BackgroundColor="#F44336"
                            TextColor="White"
                            Padding="12,6"
                            Margin="0,8,0,0"
                            AutomationId="TopicNodeDetailPage_RetryButton"
                            SemanticProperties.Hint="Retries the last failed operation" />
                    <Label Grid.Row="1"
                           Grid.Column="1"
                           Text="{Binding ErrorType}"
                           TextColor="#757575"
                           FontSize="10"
                           VerticalOptions="Center"
                           Margin="0,8,0,0"
                           IsVisible="{Binding ErrorType}"
                           AutomationId="TopicNodeDetailPage_ErrorType" />
                </Grid>
            </Border>

            <!-- Action buttons (LLM actions and history) -->
            <VerticalStackLayout Grid.Row="6" Spacing="8" Margin="0,8,0,0">
                <Button Text="{x:Static res:AppResources.TopicNodeDetailPage_ViewHistoryButton}"
                        Clicked="OnViewHistoryClicked"
                        IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                        BackgroundColor="#E3F2FD"
                        TextColor="#1976D2"
                        AutomationId="TopicNodeDetailPage_ViewHistory"
                        SemanticProperties.Hint="Opens the version history page for this topic node" />
                <Button Text="{x:Static res:AppResources.TopicNodeDetailPage_GenerateResponseButton}"
                        Clicked="OnGenerateResponseClicked"
                        IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                        AutomationId="TopicNodeDetailPage_GenerateResponse"
                        SemanticProperties.Hint="Uses AI to generate a response based on the prompt" />
                <Button Text="{x:Static res:AppResources.TopicNodeDetailPage_GenerateTitleButton}"
                        Clicked="OnGenerateTitleClicked"
                        IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                        AutomationId="TopicNodeDetailPage_GenerateTitle"
                        SemanticProperties.Hint="Uses AI to generate a title based on the prompt and response" />
            </VerticalStackLayout>

            <!-- Save/Cancel buttons -->
            <Grid Grid.Row="7" ColumnSpacing="8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                
                <Button Grid.Column="0"
                        Text="{x:Static res:AppResources.TopicNodeDetailPage_CancelButton}"
                        Clicked="OnCancelClicked"
                        IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                        AutomationId="TopicNodeDetailPage_Cancel"
                        SemanticProperties.Hint="Cancels editing and discards changes" />
                
                <Button Grid.Column="1"
                        Text="{x:Static res:AppResources.TopicNodeDetailPage_SaveButton}"
                        Clicked="OnSaveClicked"
                        IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                        AutomationId="TopicNodeDetailPage_Save"
                        SemanticProperties.Hint="Saves changes to this topic node" />
            </Grid>
        </Grid>
    </ScrollView>
</ContentPage>

