<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:IdeaBranch.App.ViewModels"
             xmlns:res="clr-namespace:IdeaBranch.App.Resources"
             x:Class="IdeaBranch.App.Views.TopicNodeDetailPage"
             x:DataType="vm:TopicNodeDetailViewModel"
             Title="{x:Static res:AppResources.TopicNodeDetailPage_Title}"
             AutomationId="TopicNodeDetailPage">
    <ScrollView>
        <Grid Padding="16" RowSpacing="16">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Parent path breadcrumb -->
            <Label Grid.Row="0"
                   Text="{Binding ParentPath}"
                   FontSize="12"
                   TextColor="Gray"
                   AutomationId="TopicNodeDetailPage_ParentPath" />

            <!-- Title -->
            <VerticalStackLayout Grid.Row="1" Spacing="4">
                <Label Text="{x:Static res:AppResources.TopicNodeDetailPage_TitleLabel}" FontAttributes="Bold" />
                <Entry Text="{Binding Title}"
                       Placeholder="{x:Static res:AppResources.TopicNodeDetailPage_TitlePlaceholder}"
                       AutomationId="TopicNodeDetailPage_Title"
                       SemanticProperties.Description="Enter or edit the title for this topic node" />
            </VerticalStackLayout>

            <!-- Prompt -->
            <VerticalStackLayout Grid.Row="2" Spacing="4">
                <Label Text="{x:Static res:AppResources.TopicNodeDetailPage_PromptLabel}" FontAttributes="Bold" />
                <Editor Text="{Binding Prompt}"
                        Placeholder="{x:Static res:AppResources.TopicNodeDetailPage_PromptPlaceholder}"
                        HeightRequest="100"
                        AutomationId="TopicNodeDetailPage_Prompt"
                        SemanticProperties.Description="Enter or edit the prompt text for this topic node" />
            </VerticalStackLayout>

            <!-- Response -->
            <VerticalStackLayout Grid.Row="3" Spacing="4">
                <Label Text="{x:Static res:AppResources.TopicNodeDetailPage_ResponseLabel}" FontAttributes="Bold" />
                <Editor Text="{Binding Response}"
                        Placeholder="{x:Static res:AppResources.TopicNodeDetailPage_ResponsePlaceholder}"
                        HeightRequest="200"
                        AutomationId="TopicNodeDetailPage_Response"
                        SemanticProperties.Description="Enter or edit the response text for this topic node" />
            </VerticalStackLayout>

            <!-- Error banner with retry -->
            <Border Grid.Row="4"
                    BackgroundColor="#FFEBEE"
                    StrokeThickness="1"
                    Stroke="#F44336"
                    Padding="12"
                    Margin="0,8,0,0"
                    IsVisible="{Binding HasError}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="4" />
                </Border.StrokeShape>
                <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto" ColumnSpacing="8">
                    <Label Grid.Row="0"
                           Grid.Column="0"
                           Grid.ColumnSpan="2"
                           Text="{Binding ErrorMessage}"
                           TextColor="#C62828"
                           FontSize="14"
                           FontAttributes="Bold"
                           AutomationId="TopicNodeDetailPage_ErrorMessage" />
                    <Button Grid.Row="1"
                            Grid.Column="0"
                            Text="{x:Static res:AppResources.TopicNodeDetailPage_RetryButton}"
                            Clicked="OnRetryClicked"
                            IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                            BackgroundColor="#F44336"
                            TextColor="White"
                            Padding="12,6"
                            Margin="0,8,0,0"
                            AutomationId="TopicNodeDetailPage_RetryButton"
                            SemanticProperties.Hint="Retries the last failed operation" />
                    <Label Grid.Row="1"
                           Grid.Column="1"
                           Text="{Binding ErrorType}"
                           TextColor="#757575"
                           FontSize="10"
                           VerticalOptions="Center"
                           Margin="0,8,0,0"
                           IsVisible="{Binding ErrorType}"
                           AutomationId="TopicNodeDetailPage_ErrorType" />
                </Grid>
            </Border>

            <!-- Action buttons (LLM actions and history) -->
            <VerticalStackLayout Grid.Row="5" Spacing="8" Margin="0,8,0,0">
                <Button Text="{x:Static res:AppResources.TopicNodeDetailPage_ViewHistoryButton}"
                        Clicked="OnViewHistoryClicked"
                        IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                        BackgroundColor="#E3F2FD"
                        TextColor="#1976D2"
                        AutomationId="TopicNodeDetailPage_ViewHistory"
                        SemanticProperties.Hint="Opens the version history page for this topic node" />
                <Button Text="{x:Static res:AppResources.TopicNodeDetailPage_GenerateResponseButton}"
                        Clicked="OnGenerateResponseClicked"
                        IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                        AutomationId="TopicNodeDetailPage_GenerateResponse"
                        SemanticProperties.Hint="Uses AI to generate a response based on the prompt" />
                <Button Text="{x:Static res:AppResources.TopicNodeDetailPage_GenerateTitleButton}"
                        Clicked="OnGenerateTitleClicked"
                        IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                        AutomationId="TopicNodeDetailPage_GenerateTitle"
                        SemanticProperties.Hint="Uses AI to generate a title based on the prompt and response" />
            </VerticalStackLayout>

            <!-- Save/Cancel buttons -->
            <Grid Grid.Row="6" ColumnSpacing="8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                
                <Button Grid.Column="0"
                        Text="{x:Static res:AppResources.TopicNodeDetailPage_CancelButton}"
                        Clicked="OnCancelClicked"
                        IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                        AutomationId="TopicNodeDetailPage_Cancel"
                        SemanticProperties.Hint="Cancels editing and discards changes" />
                
                <Button Grid.Column="1"
                        Text="{x:Static res:AppResources.TopicNodeDetailPage_SaveButton}"
                        Clicked="OnSaveClicked"
                        IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                        AutomationId="TopicNodeDetailPage_Save"
                        SemanticProperties.Hint="Saves changes to this topic node" />
            </Grid>
        </Grid>
    </ScrollView>
</ContentPage>

