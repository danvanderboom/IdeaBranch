<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:IdeaBranch.App.ViewModels"
             xmlns:res="clr-namespace:IdeaBranch.App.Resources"
             x:Class="IdeaBranch.App.Views.VersionHistoryPage"
             x:DataType="vm:VersionHistoryViewModel"
             Title="{x:Static res:AppResources.VersionHistoryPage_Title}"
             AutomationId="VersionHistoryPage">
    <ScrollView>
        <Grid Padding="16" RowSpacing="16">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Node title header -->
            <Label Grid.Row="0"
                   Text="{Binding NodeTitle, StringFormat={x:Static res:AppResources.VersionHistoryPage_HistoryFor}}"
                   FontSize="18"
                   FontAttributes="Bold"
                   IsVisible="{Binding NodeTitle}"
                   AutomationId="VersionHistoryPage_NodeTitle"
                   SemanticProperties.HeadingLevel="Level1" />

            <!-- Loading indicator -->
            <ActivityIndicator Grid.Row="1"
                                IsRunning="{Binding IsLoading}"
                                IsVisible="{Binding IsLoading}"
                                AutomationId="VersionHistoryPage_LoadingIndicator" />

            <!-- Error message -->
            <Label Grid.Row="1"
                   Text="{Binding ErrorMessage}"
                   TextColor="Red"
                   IsVisible="{Binding ErrorMessage}"
                   AutomationId="VersionHistoryPage_ErrorMessage" />

            <!-- Version list -->
            <CollectionView Grid.Row="2"
                            ItemsSource="{Binding Versions}"
                            Margin="0,8,0,0"
                            SemanticProperties.Description="List of historical versions for this topic node, showing changes over time">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border BackgroundColor="White"
                                StrokeThickness="1"
                                Stroke="#E0E0E0"
                                Padding="12"
                                Margin="0,0,0,8"
                                AutomationId="{Binding VersionId, StringFormat='VersionHistoryPage_Version_{0}'}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="4" />
                            </Border.StrokeShape>
                            <VerticalStackLayout Spacing="8">
                                <!-- Timestamp and author -->
                                <HorizontalStackLayout Spacing="8">
                                    <Label Text="{Binding VersionTimestamp, StringFormat='{0:g}'}"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="Gray"
                                           AutomationId="{Binding VersionId, StringFormat='VersionHistoryPage_Version_{0}_Timestamp'}" />
                                    <Label Text="{Binding AuthorName, StringFormat={x:Static res:AppResources.VersionHistoryPage_ByAuthor}}"
                                           FontSize="12"
                                           TextColor="Gray"
                                           IsVisible="{Binding AuthorName}"
                                           AutomationId="{Binding VersionId, StringFormat='VersionHistoryPage_Version_{0}_Author'}" />
                                </HorizontalStackLayout>

                                <!-- Title (if present) -->
                                <Label Text="{Binding Title}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       IsVisible="{Binding Title}"
                                       AutomationId="{Binding VersionId, StringFormat='VersionHistoryPage_Version_{0}_Title'}" />

                                <!-- Prompt -->
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="{x:Static res:AppResources.VersionHistoryPage_PromptLabel}" FontSize="12" FontAttributes="Bold" TextColor="Gray" />
                                    <Label Text="{Binding Prompt}"
                                           FontSize="14"
                                           TextColor="Black"
                                           AutomationId="{Binding VersionId, StringFormat='VersionHistoryPage_Version_{0}_Prompt'}" />
                                </VerticalStackLayout>

                                <!-- Response -->
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="{x:Static res:AppResources.VersionHistoryPage_ResponseLabel}" FontSize="12" FontAttributes="Bold" TextColor="Gray" />
                                    <Label Text="{Binding Response}"
                                           FontSize="14"
                                           TextColor="Black"
                                           MaxLines="5"
                                           LineBreakMode="TailTruncation"
                                           AutomationId="{Binding VersionId, StringFormat='VersionHistoryPage_Version_{0}_Response'}" />
                                </VerticalStackLayout>
                            </VerticalStackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Empty state -->
            <Label Grid.Row="2"
                   Text="{x:Static res:AppResources.VersionHistoryPage_EmptyState}"
                   FontSize="14"
                   TextColor="Gray"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   IsVisible="{Binding HasVersions, Converter={StaticResource InvertedBoolConverter}}"
                   AutomationId="VersionHistoryPage_EmptyState" />
        </Grid>
    </ScrollView>
</ContentPage>

